#!/bin/bash

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#
set -e
exec 1>&2 # Redirect any output to the journal (stderr)

# some of the configuration files are generated by the container and are stored in the piler_etc volume
# during the upgrade from 1.4.4 to 1.4.7 they are not generated again so we need to remove them

# test if the systemd service piler is running
if systemctl is-active --user --quiet piler-app; then
    # test if PREV_PILER_IMAGE =~ "1.4.4"
    if [[ "${PREV_PILER_IMAGE}" =~ "1.4.4" ]]; then
        # remove the configuration files
        echo "Removing configuration files from previous version 1.4.4"
        podman exec piler-app bash -c "cd /etc/piler && rm -rf .my.cnf MANTICORE config-site.dist.php  manticore.conf manticore.conf.dist piler-nginx.conf piler-nginx.conf.dist piler.conf.dist sphinx.conf.dist"
        echo "Removing piler_manticore volume for manticore upgrade to 9.3.2"
        podman volume rm -f piler_manticore
    else 
        echo "No need to remove configuration files, previous version is not 1.4.4"
    fi
else
    echo "Piler service is not running, skipping configuration files removal"
fi
